<!DOCTYPE html>
<html lang="en">
<head th:replace="~{fragment/head}"></head>

<th:block th:replace="fragment/adminHeader :: body"></th:block>
<div id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4">밀키트 주문 목록</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active">XX개의 새로운 밀키트 재료 요청이 있습니다.</li>
            </ol>

            <!--주문 들어온 밀키트 관련 테이블-->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    밀키트 필요 재료 발주
                </div>
                <div class="card-body">

                    <form action="/adminMain" method="get" class="input-group justify-content-end ms-auto mb-3"
                          style="width: 400px;">
                        <select class="datatable-selector" name="category">
                            <option value="All">All</option>
                            <option value="firstName">firstName</option>
                            <option value="lastName">lastName</option>
                            <option value="email">email</option>
                            <option value="department">department</option>
                        </select>
                        <input type="text" class="form-control" name="keyword" placeholder="Search...">
                        <button type="submit" class="btn btn-primary">검색</button>
                    </form>

                    <table id="datatablesSimple">
                        <thead>
                        <tr>
                            <th>주문번호</th>
                            <th>밀키트 회사명</th>
                            <th>밀키트이름</th>
                            <th>밀키트 가격</th>
                            <th>주문개수</th>
                            <th>총 예상 판매가</th>
                            <th>주문일자</th>
                            <th>진행상태</th>
                            <th>재료재고확인/발주</th>
                            <th>재료출고</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="kitOrderProcess : ${kitOrderList}">
                            <td th:text="${#strings.substring(kitOrderProcess.kitOrderID, 0, 8)}"></td>
                            <td th:text="${kitOrderProcess.kitCompanyName}"></td>
                            <td th:text="${kitOrderProcess.kitName}"></td>
                            <td th:text="${kitOrderProcess.kitPrice}"></td>
                            <td th:text="${kitOrderProcess.quantity}"></td>
                            <td th:text="${kitOrderProcess.totalPrice}"></td>
                            <td th:text="${#dates.format(kitOrderProcess.kitOrderDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
                            <td th:text="${kitOrderProcess.status}"></td>
                            <td>
                                <button type="button" class="btn btn-info btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#kitSourceCheckAndOrderModal"
                                        th:attr="data-kitOrderID=${kitOrderProcess.kitOrderID},
                                                 data-kitCompanyName=${kitOrderProcess.kitCompanyName},
                                                 data-kitName=${kitOrderProcess.kitName},
                                                 data-quantity=${kitOrderProcess.quantity},
                                                 data-kitOrderDate=${#dates.format(kitOrderProcess.kitOrderDate, 'yyyy-MM-dd')}">
                                    재료확인/발주
                                </button>
                            </td>
                            <td>

                                <!--<form th:action="@{/distribution/kitOrderRelease}" method="post">
                                    <input type="hidden" name="kitOrderId" th:value="${kitOrderProcess.kitOrderID}"/>
                                    <button id="sourceSellOutButton" type="button" class="btn btn-info btn-sm">판매
                                    </button>
                                </form>-->

                                <!--<button th:onclick="test([[${kitOrderProcess.kitOrderID}]])" id="test" type="button" class="btn btn-info btn-sm">판매test
                                </button>-->

                                <!--제발되라-->
                                <button th:onclick="processKitOrder([[${kitOrderProcess.kitOrderID}]])" id="sourceSellOutButton" type="button" class="btn btn-info btn-sm">판매</button>


                                <!--<input type="hidden" name="kitOrderId" th:value="${kitOrderProcess.kitOrderID}"/>
                                <button onclick="sell()" id="sourceSellOutButton" class="btn btn-info btn-sm">판매</button>-->

                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">추가</button>
            </div>
        </div>
    </main>
</div>

<!-- 재료확인/발주 modal -->
<div class="modal fade" id="kitSourceCheckAndOrderModal" tabindex="-1" aria-labelledby="kitOrderDetailModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="employeeForm" th:action="@{/distribution/requestSourceOrder}" th:method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="kitOrderDetailModalLabel">주문 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalKitOrderID" class="form-label">주문번호</label>
                        <input type="text" class="form-control" id="modalKitOrderID" name="modalKitOrderID" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalKitCompanyName" class="form-label">밀키트 회사명</label>
                        <input type="text" class="form-control" id="modalKitCompanyName" name="modalKitCompanyName"
                               readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalKitName" class="form-label">밀키트명</label>
                        <input type="text" class="form-control" id="modalKitName" name="modalKitName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalQuantity" class="form-label">주문수량</label>
                        <input type="text" class="form-control" id="modalQuantity" name="modalQuantity" readonly>
                    </div>

                    <!-- 재료 목록 확인할 수 있는 테이블 -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>재료명</th>
                                <th>필요수량</th>
                                <th>창고 재고 수량</th>
                                <th>현재 최소가</th>
                                <th>공급업체명</th>
                            </tr>
                            </thead>
                            <tbody id="ingredientsList">
                            <!-- 여기에 JavaScript를 사용하여 동적으로 행을 추가할 것입니다. -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <label for="modalDate" class="form-label">주문일자</label>
                        <input type="text" class="form-control" id="modalDate" name="modalDate" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button id="requestOrderButton" type="button" class="btn btn-primary">재료발주요청</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- footer.html 파일을 포함합니다 -->
<th:block th:replace="fragment/adminFooter :: footer"></th:block>

<!-- Script block to handle modals -->
<script th:inline="javascript">
    // 재료확인/발주 modal 안의 정보들을 나타내는 것과 판매 버튼에 관한 document
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('employeeForm');
        const kitSourceCheckAndOrderModal = document.getElementById('kitSourceCheckAndOrderModal');

        if (kitSourceCheckAndOrderModal) {
            kitSourceCheckAndOrderModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget; // 클릭된 버튼
                const kitOrderId = button.getAttribute('data-kitOrderID');
                const kitCompanyName = button.getAttribute('data-kitCompanyName');
                const kitName = button.getAttribute('data-kitName');
                const kitQuantity = button.getAttribute('data-quantity');
                const kitOrderDate = button.getAttribute('data-kitOrderDate');

                // 폼 필드에 값 설정
                document.getElementById('modalKitOrderID').value = kitOrderId;
                document.getElementById('modalKitCompanyName').value = kitCompanyName;
                document.getElementById('modalKitName').value = kitName;
                document.getElementById('modalQuantity').value = kitQuantity;
                document.getElementById('modalDate').value = kitOrderDate;

                // 주문에 해당하는 밀키트 재료 목록을 로드
                fetch(`/distribution/kitOrderRecipe?kitOrderID=${kitOrderId}`)
                    .then(response => response.json())
                    .then(data => {
                        const ingredientsList = document.getElementById('ingredientsList');
                        ingredientsList.innerHTML = ''; // 기존 내용을 초기화

                        data.forEach(ingredient => {
                            const row = `<tr>
                                <td>${ingredient['재료명']}</td>
                                <td>${ingredient['필요수량']}</td>
                                <td>${ingredient['창고재고수량']}</td>
                                <td>${ingredient['현재최소가']}</td>
                                <td>${ingredient['공급업체명']}</td>
                            </tr>`;
                            ingredientsList.innerHTML += row;
                        });
                    })
                    .catch(error => console.error('Error fetching the ingredients:', error));
            });
        }
    });

    const test = (id) => console.log(id);

    // json 방법
    document.getElementById('requestOrderButton').addEventListener('click', function (event) {
        event.preventDefault(); // 기본 폼 제출 방지

        const orderDetails = [];
        const kitOrderId = document.getElementById('modalKitOrderID').value;
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        console.log(csrfToken);
        console.log(csrfHeader);

        // 재료 테이블에서 데이터 추출(모달 안에 적혀있는 값을 불러옴)
        document.querySelectorAll("#ingredientsList tr").forEach(row => {
            const sourceName = row.cells[0].innerText; // 재료이름
            const requiredQuantity = parseInt(row.cells[1].innerText); // 필요수량
            const warehouseQuantity = parseInt(row.cells[2].innerText); // 창고재고수량
            const minPrice = parseInt(row.cells[3].innerText); // 현재 최소가
            const supplierName = row.cells[4].innerText; // 재료 공급업체명

            // 재고 부족 시 발주 내역 추가
            if (requiredQuantity > warehouseQuantity) {
                const insufficientQuantity = requiredQuantity - warehouseQuantity;
                orderDetails.push({
                    sourceName: sourceName,
                    supplierName: supplierName,
                    minPrice: minPrice,
                    insufficientQuantity: insufficientQuantity
                });
            }
        });

        orderDetails.map((order) => console.log(order));
        console.log(orderDetails);
        console.log({kitOrderId, orderDetails}); // 서버로 보내기 전에 확인
        console.log(JSON.stringify(orderDetails))
        console.log(JSON.stringify({
            orderDetails: orderDetails
        }))
        console.log(JSON.stringify({
            kitOrderId: kitOrderId,
            orderDetails: {
                "orderDetails": orderDetails
            }
        }));
        // 서버로 재료 발주 요청
        if (orderDetails.length > 0) {
            fetch("/distribution/requestSourceOrder", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken // CSRF 토큰을 헤더에 포함
                },
                body: JSON.stringify({
                    kitOrderId: kitOrderId,
                    orderDetailList: orderDetails
                })
                // body: JSON.stringify({ kitOrderId, orderDetails }),
            })
                .then(() => {
                    alert('재료 발주 요청이 완료되었습니다.');
                    window.location.href = '/distribution/main';  // 성공 후 리다이렉트
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        } else {
            alert("모든 재고가 충분합니다.");
        }
    });

/*$(document).ready(function (){
    $("#sourceSellOutButton").on("click",function (){
        $("#").submit
    })
})*/
    // 판매 버튼 ajax
    /*document.addEventListener('DOMContentLoaded', () => {
        const sellOutButtons = document.querySelectorAll('#sourceSellOutButton');

        sellOutButtons.forEach((button) => {
            button.addEventListener('click', (event) => {
                event.preventDefault(); // 기본 폼 제출 방지

                const form = this.closest('form'); // 클릭한 버튼의 form을 찾음
                const kitOrderId = form.querySelector('input[name="kitOrderId"]').value; // form에서 주문 번호 추출(input 안에 있는 name
                // 값을 value 로 가져옴
                console.log(kitOrderId);

                // CSRF 토큰 설정 (Spring Security 사용 시)
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                console.log(csrfToken);
                console.log(csrfHeader);

                // AJAX 요청 보내기
                fetch("/distribution/kitOrderRelease", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        [csrfHeader]: csrfToken // CSRF 토큰 포함
                    },
                    body: JSON.stringify({kitOrderId: kitOrderId})
                })
                    .then(response => response.json()) // JSON 응답 받기 (컨트롤러에서 return ResponseEntity.ok(response); 한 것을 받아옴)
                    .then(data => {
                        if (data.status === "success") {
                            alert(data.message); // 성공 메시지
                            window.location.href = '/distribution/main?success=true'; // 성공 시 리다이렉트
                        } else {
                            alert(data.message); // 실패 메시지
                            window.location.href = '/distribution/main?error=insufficientStock'; // 실패 시 리다이렉트
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert('오류가 발생했습니다. 다시 시도해 주세요.');
                    });
            });
        });
    });*/


    /*document.addEventListener('DOMContentLoaded', () => {
        const sellOutButtons = document.querySelectorAll('#sourceSellOutButton');
        //console.log(sellOutButtons)

        sellOutButtons.forEach((button) => {
            //console.log(button)
            button.addEventListener('click', (event) => {

                //console.log('test')
                event.preventDefault(); // 기본 폼 제출 방지

                // 주문 번호를 인자로 받아서 처리하는 함수
                const processKitOrder = (kitOrderId) => {
                    console.log(kitOrderId); // 서버에서 넘어온 kitOrderId 값 확인

                    // CSRF 토큰 설정 (Spring Security 사용 시)
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
                    console.log(csrfToken);
                    console.log(csrfHeader);

                    // AJAX 요청 보내기
                    fetch("/distribution/kitOrderRelease", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            [csrfHeader]: csrfToken // CSRF 토큰 포함
                        },
                        body: JSON.stringify({ kitOrderId: kitOrderId }) // 서버로 전달할 JSON 데이터
                    })
                        .then(response => response.json()) // JSON 응답 받기
                        .then(data => {
                            if (data.status === "success") {
                                alert(data.message); // 성공 메시지
                                window.location.href = '/distribution/main?success=true'; // 성공 시 리다이렉트
                            } else {
                                alert(data.message); // 실패 메시지
                                window.location.href = '/distribution/main?error=insufficientStock'; // 실패 시 리다이렉트
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert('오류가 발생했습니다. 다시 시도해 주세요.');
                        });
                };



            });
        });
    });*/

    // 주문 번호를 인자로 받아서 처리하는 함수 (전역에 정의)
    const processKitOrder = (kitOrderId) => {
        console.log(kitOrderId); // 서버에서 넘어온 kitOrderId 값 확인

        // CSRF 토큰 설정 (Spring Security 사용 시)
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        // AJAX 요청 보내기
        fetch("/distribution/kitOrderRelease", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken // CSRF 토큰 포함
            },
            body: JSON.stringify({ kitOrderId: kitOrderId }) // 서버로 전달할 JSON 데이터
        })
            .then(response => response.json()) // JSON 응답 받기
            .then(data => {
                if (data.status === "success") {
                    alert(data.message); // 성공 메시지
                    window.location.href = '/distribution/main?success=true'; // 성공 시 리다이렉트
                } else {
                    alert(data.message); // 실패 메시지
                    window.location.href = '/distribution/main?error=insufficientStock'; // 실패 시 리다이렉트
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert('오류가 발생했습니다. 다시 시도해 주세요.');
            });
    };




</script>
</html>
