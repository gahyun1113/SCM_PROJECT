<!DOCTYPE html>
<html lang="en">
<head th:replace="~{fragment/head}"></head>

<th:block th:replace="fragment/adminHeader :: body"></th:block>
<div id="layoutSidenav_content">
    <!-- 페이지마다 다른 콘텐츠 -->
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4">밀키트 주문 목록</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active">XX개의 새로운 밀키트 재료 요청이 있습니다.</li>
            </ol>

            <!--주문 들어온 밀키트 관련 테이블-->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    밀키트 필요 재료 발주
                </div>
                <div class="card-body">

                    <form action="/adminMain" method="get" class="input-group justify-content-end ms-auto mb-3" style="width: 400px;">
                        <select class="datatable-selector" name="category">
                            <option value="All">All</option>
                            <option value="firstName">firstName</option>
                            <option value="lastName">lastName</option>
                            <option value="email">email</option>
                            <option value="department">department</option>
                        </select>
                        <input type="text" class="form-control" name="keyword" placeholder="Search...">
                        <button type="submit" class="btn btn-primary">검색</button>
                    </form>




                    <table id="datatablesSimple">
                        <thead>
                        <tr>
                            <th>주문번호</th>
                            <th>밀키트 회사명</th>
                            <th>밀키트이름</th>
                            <th>밀키트 가격</th>
                            <th>주문개수</th>
                            <th>총 예상 판매가</th>
                            <th>주문일자</th>
                            <th>진행상태</th>
                            <th>재료재고확인/발주</th>
                            <th>재료출고</th>
                        </tr>
                        </thead>

                        <!--tbody > tr > td-->
                        <tbody>
                        <tr th:each="kitOrderProcess : ${kitOrderList}">
                            <td th:text="${#strings.substring(kitOrderProcess.kitOrderID, 0, 8)}"></td>
                            <td th:text="${kitOrderProcess.kitCompanyName}"></td>
                            <td th:text="${kitOrderProcess.kitName}"></td>
                            <td th:text="${kitOrderProcess.kitPrice}"></td>
                            <td th:text="${kitOrderProcess.quantity}"></td>
                            <td th:text="${kitOrderProcess.totalPrice}"></td>
                            <td th:text="${#dates.format(kitOrderProcess.kitOrderDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
                            <td th:text="${kitOrderProcess.status}"></td>
                            <!--<td>
                                 삭제
                                <form th:action="@{/adminMain/delete/{id}(id=${emp.id})}" method="post">
                                    <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                                </form>
                            </td>-->
                            <td>
                                <button type="button" class="btn btn-info btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#kitSourceCheckAndOrderModal"
                                        th:attr="data-kitOrderID=${kitOrderProcess.kitOrderID},
                                                 data-kitCompanyName=${kitOrderProcess.kitCompanyName},
                                                 data-kitName=${kitOrderProcess.kitName},
                                                 data-quantity=${kitOrderProcess.quantity},
                                                 data-kitOrderDate=${#dates.format(kitOrderProcess.kitOrderDate, 'yyyy-MM-dd')}">
                                    재료확인/발주
                                </button>
                            </td>
                            <td>
                                <form th:action="@{/distribution/kitOrderRelease}" method="post">
                                    <input type="hidden" name="kitOrderId" th:value="${kitOrderProcess.kitOrderID}"/>
                                    <button type="submit" class="btn btn-info btn-sm">
                                        판매
                                    </button>
                                </form>

                            </td>
                        </tr>

                        </tbody>
                    </table>
                </div>
            </div>

            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">추가</button>
            </div>

            <!-- 재료 발주 받아 전달 준비가 된 것들 보이는 테이블-->
            <!--<div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    창고에서 물건 빼서 밀키트 회사에 보내주기
                </div>
                <div class="card-body">

                    <form action="/adminMain" method="get" class="input-group justify-content-end ms-auto mb-3" style="width: 400px;">
                        <select class="datatable-selector" name="category">
                            <option value="All">All</option>
                            <option value="firstName">firstName</option>
                            <option value="lastName">lastName</option>
                            <option value="email">email</option>
                            <option value="department">department</option>
                        </select>
                        <input type="text" class="form-control" name="keyword" placeholder="Search...">
                        <button type="submit" class="btn btn-primary">검색</button>
                    </form>


                    <table id="datatablesSimple02">
                        <thead>
                        <tr>
                            <th>주문번호</th>
                            <th>밀키트 회사명</th>
                            <th>밀키트이름</th>
                            <th>밀키트 가격</th>
                            <th>주문개수</th>
                            <th>총 예상 판매가</th>
                            <th>주문일자</th>
                            <th>진행상태</th>
                            <th>재료 보내기</th>
                        </tr>
                        </thead>

                        &lt;!&ndash;tbody > tr > td&ndash;&gt;
                        <tbody>
                        <tr th:each=" kitOrderProcess : ${kitOrderList}" >

                            <td th:text="${#strings.substring(kitOrderProcess.kitOrderID, 0, 8)}"></td>
                            <td th:text="${kitOrderProcess.kitCompanyName}"></td>
                            <td th:text="${kitOrderProcess.kitName}"></td>
                            <td th:text="${kitOrderProcess.kitPrice}"></td>
                            <td th:text="${kitOrderProcess.quantity}"></td>
                            <td th:text="${kitOrderProcess.totalPrice}"></td>
                            <td th:text="${#dates.format(kitOrderProcess.kitOrderDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
                            <td th:text="${kitOrderProcess.status}"></td>
                            &lt;!&ndash;<td>
                                 삭제
                                <form th:action="@{/adminMain/delete/{id}(id=${emp.id})}" method="post">
                                    <button type="submit" class="btn btn-danger btn-sm">삭제</button>
                                </form>
                            </td>&ndash;&gt;
                            <td>
                                <button type="button" class="btn btn-info btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#empModal">
                                    &lt;!&ndash;th:attr="data-id=${emp.id}, data-firstname=${emp.firstName}, data-lastname=${emp.lastName}, data-email=${emp.email}, data-department=${emp.department}, data-hiredate=${emp.hireDate}">&ndash;&gt;
                                    재료판매
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">추가</button>
            </div>-->



        </div>
    </main>
</div>

<!-- 재료확인/발주 modal -->
<div class="modal fade" id="kitSourceCheckAndOrderModal" tabindex="-1" aria-labelledby="kitOrderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="employeeForm" th:action="@{/distribution/kitSourceCheckAndOrder}" th:method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="kitOrderDetailModalLabel">주문 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalKitOrderID" class="form-label">주문번호</label>
                        <input type="text" class="form-control" id="modalKitOrderID" name="modalKitOrderID" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalKitCompanyName" class="form-label">밀키트 회사명</label>
                        <input type="text" class="form-control" id="modalKitCompanyName" name="modalKitCompanyName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalKitName" class="form-label">밀키트명</label>
                        <input type="text" class="form-control" id="modalKitName" name="modalKitName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalQuantity" class="form-label">주문수량</label>
                        <input type="text" class="form-control" id="modalQuantity" name="modalQuantity" readonly>
                    </div>

                    <!-- 재료 목록 확인할 수 있는 테이블 -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>재료명</th>
                                <th>필요수량</th>
                                <th>창고 재고 수량</th>
                            </tr>
                            </thead>
                            <tbody id="ingredientsList">
                            <!-- 여기에 JavaScript를 사용하여 동적으로 행을 추가할 것입니다. -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <label for="modalDate" class="form-label">날짜</label>
                        <input type="text" class="form-control" id="modalDate" name="modalDate" readonly>
                    </div>
                    <!-- CSRF Token -->
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">재료발주요청</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 추가 모달 -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addEmployeeForm" th:action="@{/adminMain/insert}" th:method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEmployeeModalLabel">새 직원 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addEmpFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="addEmpFirstName" name="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEmpLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="addEmpLastName" name="lastName" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEmpEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="addEmpEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEmpDepartment" class="form-label">Department</label>
                        <input type="text" class="form-control" id="addEmpDepartment" name="department" required>
                    </div>
                    <div class="mb-3">
                        <label for="addEmpHireDate" class="form-label">Hire Date</label>
                        <input type="date" class="form-control" id="addEmpHireDate" name="hireDate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">재료발주요청</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- footer.html 파일을 포함합니다 -->
<th:block th:replace="fragment/adminFooter :: footer"></th:block>

<!-- Script block to handle modals -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {

        const form = document.getElementById('employeeForm');
        const kitSourceCheckAndOrderModal = document.getElementById('kitSourceCheckAndOrderModal');

        if (kitSourceCheckAndOrderModal) {
            kitSourceCheckAndOrderModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget; // 클릭된 버튼
                const kitOrderId = button.getAttribute('data-kitOrderID');
                const kitCompanyName = button.getAttribute('data-kitCompanyName');
                const kitName = button.getAttribute('data-kitName');
                const kitQuantity = button.getAttribute('data-quantity');
                const kitOrderDate = button.getAttribute('data-kitOrderDate');

                // 폼 필드에 값 설정
                document.getElementById('modalKitOrderID').value = kitOrderId;
                document.getElementById('modalKitCompanyName').value = kitCompanyName;
                document.getElementById('modalKitName').value = kitName;
                document.getElementById('modalQuantity').value = kitQuantity;
                document.getElementById('modalDate').value = kitOrderDate;

                // 주문에 해당하는 밀키트 재료 목록을 로드
                fetch(`/distribution/kitOrderRecipe?kitOrderID=${kitOrderId}`)
                    .then(response => response.json())
                    .then(data => {
                        const ingredientsList = document.getElementById('ingredientsList');
                        ingredientsList.innerHTML = ''; // 기존 내용을 초기화

                            data.forEach(ingredient => {
                                const row = `<tr>
                                            <td>${ingredient['재료명']}</td>
                                            <td>${ingredient['필요수량']}</td>
                                            <td>${ingredient['창고재고수량']}</td>
                                         </tr>`;
                                ingredientsList.innerHTML += row;
                            });
                        })
                        .catch(error => console.error('Error fetching the ingredients:', error));

                    // 중복 방지를 위해 기존 숨겨진 input이 있는지 확인
                    let kitOrderIDInput = document.querySelector('input[name="kitOrderIDName"]');
                    if (!kitOrderIDInput) {
                        kitOrderIDInput = document.createElement('input');
                        kitOrderIDInput.type = 'hidden';
                        kitOrderIDInput.name = 'kitOrderIDName';
                        form.appendChild(kitOrderIDInput); // 폼에 숨겨진 필드를 추가
                    }

                    kitOrderIDInput.value = kitOrderId; // 필요한 경우 여기에 올바른 값 할당

                    form.action = '/distribution/kitSourceCheckAndOrder'; // 실제 URL로 설정
                });
        }
    });
</script>




</html>
