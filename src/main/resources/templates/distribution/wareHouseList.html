<!DOCTYPE html>
<html lang="en">
<head>
    <th:block th:replace="fragment/adminHeader :: head"></th:block>
    <!-- 추가적인 CSS 및 JavaScript 파일 링크 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 날짜 포맷 함수 정의
            function formatDate(dateString) {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
                const day = String(date.getDate()).padStart(2, '0'); // 날짜에 0을 추가하여 두 자리로 맞춤

                return `${year}-${month}-${day}`;
            }

            // 모달이 열릴 때 이벤트 리스너 설정
            var LogModal = document.getElementById('LogModal');

            LogModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var sourceId = button.getAttribute('data-source-id');
                console.log("sourceId>>>>>>> " + sourceId);

                if (sourceId) {
                    const encodedSourceId = encodeURIComponent(sourceId);

                    // Fetch API를 이용해 서버에서 데이터를 가져옴
                    fetch(`/wareHouse/selectLog?sourceId=${encodedSourceId}`)
                        .then(response => {
                            if (!response.ok) {
                                console.error('HTTP 오류:', response.status, response.statusText);
                                throw new Error('네트워크 응답에 문제가 있습니다.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // 서버로부터 받은 데이터를 모달에 채움
                            const tbody = document.querySelector('#LogModal .modal-body tbody');
                            tbody.innerHTML = ''; // 기존 데이터를 지움

                            data.forEach(item => {
                                const formattedDate = formatDate(item.orderDate);

                                tbody.innerHTML += `
                            <tr>
                                <td>${item.companyName}</td>
                                <td>${item.sourceName}</td>
                                <td>${item.quantity}</td>
                                <td>${formattedDate}</td>

                                <td>${item.status}</td>
                            </tr>
                        `;
                            });

                            // 모달을 보여줌 (이 부분은 이미 처리되므로 중복 호출을 제거함)
                        })
                        .catch(error => {
                            console.error('Fetch 오류:', error);
                        });
                } else {
                    console.error('sourceId가 정의되지 않았습니다.');
                }
            });
        });
    </script>
</head>
<body>
<th:block th:replace="fragment/adminHeader :: body"></th:block>
<div id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4 mb-4">창고 재고 확인</h1>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    창고 재고 확인
                </div>
                <div class="card-body">
                    <form action="/sales" method="get" class="input-group justify-content-end ms-auto mb-3" style="width: 400px;">
                        <select class="datatable-selector" name="category">
                            <option value="All">All</option>
                            <option value="sourceName">재료명</option>
                            <option value="productCompanyName">업체명</option>
                        </select>
                        <input type="text" class="form-control" name="keyword" placeholder="Search...">
                        <button type="submit" class="btn btn-primary">검색</button>
                    </form>

                    <table id="datatablesSimple">
                        <thead>
                        <tr>
                            <th>창고이름</th>
                            <th>재료명</th>
                            <th>수량</th>
                            <th>상세</th>
                        </tr>
                        </thead>
                        <tfoot>
                        <tr>
                            <th>창고이름</th>
                            <th>재료명</th>
                            <th>수량</th>
                            <th>상세</th>
                        </tr>
                        </tfoot>
                        <tbody>
                        <tr th:each="items : ${warehouseList}">
                            <td th:text="${items.wareHouseName}"></td>
                            <td th:text="${items.sourceName}"></td>
                            <td th:text="${items.quantity}"></td>
                            <td>
                                <button class="btn btn-primary"
                                        type="button"
                                        data-bs-toggle="modal"
                                        data-bs-target="#LogModal"
                                        th:attr="data-source-id=${items.sourceUUID}"

                                >
<!-- 상세-->                          로그버튼
                                </button>

                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 로그 모달 Modal -->
            <div class="modal fade" id="LogModal" tabindex="-1" aria-labelledby="LogModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="LogModalLabel">발주</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>업체명</th>
                                    <th>재료명</th>
                                    <th>수량</th>
                                    <th>날짜</th>
                                    <th>상태</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- 여기에 Fetch API로 데이터가 채워짐 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal div end -->

            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">추가</button>
            </div>
        </div>
    </main>
</div>

<th:block th:replace="fragment/adminFooter :: footer"></th:block>
</body>



</html>
