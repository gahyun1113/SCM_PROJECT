<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.jhta_2402_2_final.dao.distribution.DistributionSourcePriceDao">

    <!-- 특정 밀키트의 재료와 가격을 조회하는 쿼리 -->
    <select id="getSourcePricesForKit" resultType="DistributionMaterialDto">
        SELECT
            sp.SOURCE_ID AS sourceId,
            s.NAME AS materialName,
            sp.PRICE AS price,
            pc.NAME AS supplierName
        FROM
            SOURCE_PRICE sp
                JOIN SOURCE s ON sp.SOURCE_ID = s.SOURCE_ID
                JOIN PRODUCT_COMPANY pc ON sp.PRODUCT_COMPANY_ID = pc.PRODUCT_COMPANY_ID
        WHERE
            sp.SOURCE_ID = #{kitId}
    </select>


    <!-- 각 재료별 최저가 제공 업체를 조회하는 쿼리 -->
    <select id="getBestSuppliers" resultType="DistributionMaterialDto">
        SELECT
            sp.SOURCE_ID AS sourceId,
            s.NAME AS materialName,
            MIN(sp.PRICE) AS lowestPrice,
            pc.NAME AS bestSupplierName
        FROM
            SOURCE_PRICE sp
                JOIN SOURCE s ON sp.SOURCE_ID = s.SOURCE_ID
                JOIN PRODUCT_COMPANY pc ON sp.PRODUCT_COMPANY_ID = pc.PRODUCT_COMPANY_ID
        GROUP BY
            sp.SOURCE_ID, s.NAME, pc.NAME
    </select>

    <!-- 주문 내역을 조회하는 쿼리 -->
    <select id="getOrderDetails" resultType="DistributionMaterialDto">
        SELECT
            KO.KIT_ORDER_ID AS orderId,
            M.NAME AS mealkitName,
            M.PRICE AS price,
            KC.NAME AS supplierName
        FROM
            KIT_ORDER KO
                JOIN KIT_COMPANY KC ON KO.KIT_COMPANY_ID = KC.KIT_COMPANY_ID
                JOIN MEALKIT M ON KO.MEALKIT_ID = M.MEALKIT_ID
    </select>

    <!-- 전체 소스 가격 리스트를 조회하는 쿼리 -->
    <select id="getAllSourcePrices" resultType="DistributionMaterialDto">
        SELECT
            sp.SOURCE_ID AS sourceId,
            s.NAME AS materialName,
            sp.PRICE AS price,
            pc.NAME AS supplierName
        FROM
            SOURCE_PRICE sp
                JOIN SOURCE s ON sp.SOURCE_ID = s.SOURCE_ID
                JOIN PRODUCT_COMPANY pc ON sp.PRODUCT_COMPANY_ID = pc.PRODUCT_COMPANY_ID
    </select>


    <!-- 카테고리와 키워드에 따른 소스 가격 리스트를 조회하는 쿼리 -->
    <select id="findSourcePricesByCategoryAndKeyword" resultType="DistributionMaterialDto">
        SELECT
        sp.SOURCE_ID AS sourceId,
        s.NAME AS materialName,
        sp.PRICE AS price,
        pc.NAME AS supplierName
        FROM
        SOURCE_PRICE sp
        JOIN SOURCE s ON sp.SOURCE_ID = s.SOURCE_ID
        JOIN PRODUCT_COMPANY pc ON sp.PRODUCT_COMPANY_ID = pc.PRODUCT_COMPANY_ID
        WHERE
        <choose>
            <when test="category == 'productCompanyName'">
                pc.NAME LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="category == 'sourceName'">
                s.NAME LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <otherwise>
                pc.NAME LIKE CONCAT('%', #{keyword}, '%')
                OR s.NAME LIKE CONCAT('%', #{keyword}, '%')
            </otherwise>
        </choose>
    </select>


</mapper>
